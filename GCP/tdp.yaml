# Docs:
# https://cloud.google.com/deployment-manager/images/network-load-balanced-diagram.svg
# https://cloud.google.com/deployment-manager/docs/configuration/supported-resource-types
# https://github.com/GoogleCloudPlatform/deploymentmanager-samples/blob/master/examples/v2/instance_pool/jinja/instance-pool.jinja

# Docs:
# To create a new deployment, run:

#         $ gcloud deployment-manager deployments create my-deployment \
#             --config config.yaml --description "My deployment"

#     To preview a deployment without actually creating resources, run:

#         $ gcloud deployment-manager deployments create my-new-deployment \
#             --config config.yaml --preview


# Firewall rules
resources:
- type: compute.v1.firewall
  name: fw-in
  properties:
    description: firewall - from internet to LB
    sourceRanges:
      - 0.0.0.0/0
    allowed:
      - IPProtocol: TCP
        ports:
        - 80
        - 443
      - IPProtocol: UDP
        ports:
        - 443

# forwarding rule for load balancing tcp:80
- type: compute.v1.forwardingRule
  name: fwd-tcp-80
  properties:
    description: Forwarding rule for load balancing - TCP 80
    region: europe-west2
    target: $(ref.tp.selfLink)
    loadBalancingScheme: EXTERNAL 
    IPProtocol: TCP
    portRange: 80
    IPAddress: $(ref.static-ip.selfLink)

# forwarding rule for load balancing tcp:443
- type: compute.v1.forwardingRule
  name: fwd-tcp-443
  properties:
    description: Forwarding rule for load balancing - TCP 443
    region: europe-west2
    target: $(ref.tp.selfLink)
    loadBalancingScheme: EXTERNAL
    IPProtocol: TCP
    portRange: 443
    IPAddress: $(ref.static-ip.selfLink)

# forwarding rule for load balancing udp:443
- type: compute.v1.forwardingRule
  name: fwd-udp-443
  properties:
    description: Forwarding rule for load balancing - UDP 443
    region: europe-west2
    target: $(ref.tp.selfLink)
    loadBalancingScheme: EXTERNAL
    IPProtocol: UDP
    portRange: 443
    IPAddress: $(ref.static-ip.selfLink)

# target pool - this is an LB front-end
- type: compute.v1.targetPool
  name: tp
  properties:
    description: Target pool for load balancing - TCP and UDP
    region: europe-west2
    # healthChecks:
    #   - $(ref.hc-tdp.selfLink)

# instance healthcheck
# - type: compute.v1.httpHealthCheck
#   name: hc-tdp
#   properties:
#     port: 443
#     requestPath: /

# instance template 
- type: compute.v1.instanceTemplate
  name: it
  properties:
    properties:
      description: "Instance template"
      machineType: f1-micro
      canIpForward: false
      networkInterfaces:
        - network: https://www.googleapis.com/compute/v1/projects/proud-limiter-136618/global/networks/default
          accessConfigs:
          - name: external-nat
            type: ONE_TO_ONE_NAT
      disks:
        - deviceName: boot
          boot: true
          autoDelete: true
          mode: READ_WRITE
          type: PERSISTENT
          initializeParams:
            sourceImage: projects/proud-limiter-136618/global/images/thedotproduct-web-v8
            diskSizeGb: 20
            diskType: pd-ssd
      serviceAccounts:
        - email: 780388432073-compute@developer.gserviceaccount.com
          scopes:
            - https://www.googleapis.com/auth/devstorage.read_only


# Instance group manager - manages the instances
- type: compute.v1.instanceGroupManager
  name: igm
  properties:
    zone: europe-west2-b
    description: "Just a simple instance group manager for the service" 
    baseInstanceName: "tdp"
    instanceTemplate: $(ref.it.selfLink)
    namedPorts:
      - name: http
        port: 80
      - name: https
        port: 443
    network: https://www.googleapis.com/compute/v1/projects/proud-limiter-136618/global/networks/default
    targetSize: 1
    targetPools:
      - $(ref.tp.selfLink)

# Autoscaling config
- type: compute.v1.autoscaler
  name: as
  properties:
    zone: europe-west2-b
    description: "Just a simple AS for the service"
    target: $(ref.igm.selfLink)
    autoscalingPolicy:
      minNumReplicas: 1
      maxNumReplicas: 1
      coolDownPeriodSec: 60
      cpuUtilization:
        utilizationTarget: 0.60

# Fixed IP address which will be used by all forwarding rules
- type: compute.v1.address
  name: static-ip
  properties:
    region: europe-west2