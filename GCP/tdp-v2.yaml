# TODO
# change to globals:
#   compute.v1.globalAddress	
#   compute.v1.globalForwardingRule	
# 
# Add ipv6 (has to be global)
# 
# change to region IG/Ms
#   compute.v1.regionInstanceGroup
#   compute.v1.regionInstanceGroupManager
#
# PROB NOT, ONLY 1 INSTANCE -- Add session affinty to LB - might fix QUIC 
#
# Limit inbound to instances to LBs - there's a defined IP list/range on the healthcheck docs: https://cloud.google.com/compute/docs/load-balancing/network/#firewall_rules_and_network_load_balancing

# Docs:
# https://cloud.google.com/deployment-manager/images/network-load-balanced-diagram.svg
# https://cloud.google.com/deployment-manager/docs/configuration/supported-resource-types
# https://github.com/GoogleCloudPlatform/deploymentmanager-samples/blob/master/examples/v2/instance_pool/jinja/instance-pool.jinja

# Docs:
# To create a new deployment, run:

#         $ gcloud deployment-manager deployments create my-deployment \
#             --config config.yaml --description "My deployment"

#     To preview a deployment without actually creating resources, run:

#         $ gcloud deployment-manager deployments create my-new-deployment \
#             --config config.yaml --preview


resources:
# Fixed IP address which will be used by the VM
# - type: compute.v1.address
#   name: tdp-static-ip-v0
#   properties:
#     region: europe-west2

# Firewall rules
- type: compute.v1.firewall
  name: tdp-vm-fw-v0
  properties:
    description: Firewall (internet -> VM)
    sourceRanges:
      - 0.0.0.0/0
    targetTags:
      - quic
    allowed:
      - IPProtocol: TCP
        ports:
        - 80
        - 443
      - IPProtocol: UDP
        ports:
        - 443

# instance template 
- type: compute.v1.instanceTemplate
  name: tdp-it-v0
  properties:
    properties:
      description: "Instance template"
      machineType: f1-micro
      canIpForward: false
      tags:
        items:
          - quic
      networkInterfaces:
        - network: https://www.googleapis.com/compute/v1/projects/proud-limiter-136618/global/networks/default
          accessConfigs:
            - kind: compute#accessConfig
              name: ext-ip
              # natIP: $(ref.tdp-static-ip-v0.selfLink)
              type: ONE_TO_ONE_NAT
      disks:
        - deviceName: boot
          boot: true
          autoDelete: true
          mode: READ_WRITE
          type: PERSISTENT
          initializeParams:
            sourceImage: projects/proud-limiter-136618/global/images/thedotproduct-web-v11
            diskSizeGb: 20
            diskType: pd-ssd
      serviceAccounts:
        - email: 780388432073-compute@developer.gserviceaccount.com
          scopes:
            - https://www.googleapis.com/auth/devstorage.read_only

# Instance group manager - manages the instances WRT the ASG
- type: compute.v1.instanceGroupManager
  name: tdp-igm-v0
  properties:
    zone: europe-west2-b
    description: "Just a simple instance group manager for the service" 
    baseInstanceName: "tdp-v0"
    instanceTemplate: $(ref.tdp-it-v0.selfLink)
    namedPorts:
      - name: http
        port: 80
      - name: https
        port: 443
    network: https://www.googleapis.com/compute/v1/projects/proud-limiter-136618/global/networks/default
    targetSize: 1

# Autoscaling config
- type: compute.v1.autoscaler
  name: tdp-as-v0
  properties:
    zone: europe-west2-b
    description: "Just a simple AS for the service"
    target: $(ref.tdp-igm-v0.selfLink)
    autoscalingPolicy:
      minNumReplicas: 1
      maxNumReplicas: 1
      coolDownPeriodSec: 60
      cpuUtilization:
        utilizationTarget: 0.60